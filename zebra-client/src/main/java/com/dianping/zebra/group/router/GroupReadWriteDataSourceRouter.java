package com.dianping.zebra.group.router;import java.sql.SQLException;import java.util.ArrayList;import java.util.List;import java.util.Map;import com.dianping.zebra.group.config.BaseGroupConfigChangeEvent;import com.dianping.zebra.group.config.GroupConfigChangeListener;import com.dianping.zebra.group.config.datasource.entity.DataSourceConfig;import com.dianping.zebra.group.util.SqlUtils;/** * 对等数据库管理器 可以是读对等：如多个读库，每个库的数据完全相同。对等读取 可以是写对等：如日志库，每个库数据不同，一条数据写入哪个库都可以。对等写入 *  * 支持动态推送权重，动态加减库。 *  * TODO <br> * 1. 监听config变化，activeDataSource list 变化时，重新构造。<br> * 2. Factory.get('roundrobin')返回DataSourceId */public class GroupReadWriteDataSourceRouter extends AbstractGroupDataSourceRouter implements GroupConfigChangeListener {	// private static final Logger logger = LoggerFactory.getLogger(ReadWriteDataSourcerouter.class);	private GroupWeightDataSourceRouter readrouter;	private GroupWeightDataSourceRouter writerouter;	public GroupReadWriteDataSourceRouter(Map<String, DataSourceConfig> DataSourceConfigs) {		this.init(DataSourceConfigs);	}	public void init(Map<String, DataSourceConfig> DataSourceConfigs) {		List<DataSourceConfig> readDataSourceConfigs = new ArrayList<DataSourceConfig>();		List<DataSourceConfig> writeDataSourceConfigs = new ArrayList<DataSourceConfig>();		for (DataSourceConfig config : DataSourceConfigs.values()) {			boolean readonly = config.isReadonly();			if (readonly) {				readDataSourceConfigs.add(config);			} else {				writeDataSourceConfigs.add(config);			}		}		this.readrouter = new GroupWeightDataSourceRouter(readDataSourceConfigs, true);		this.writerouter = new GroupWeightDataSourceRouter(writeDataSourceConfigs, false);	}	@Override	public GroupDataSourceTarget select(GroupDataSourceRouterInfo routerInfo) {		// 判断出sql的SqlType，算出它是read还是write		SqlType sqlType = getSqlType(routerInfo);		if (sqlType.isRead()) {			return readrouter.select(routerInfo);		} else {			return writerouter.select(routerInfo);		}	}	private SqlType getSqlType(GroupDataSourceRouterInfo routerInfo) {		String sql = routerInfo.getSql();		try {			return SqlUtils.getSqlType(sql);		} catch (SQLException e) {			throw new RuntimeException(e.getMessage(), e);		}	}	public String getName() {		return this.getName();	}	@Override	public void onChange(BaseGroupConfigChangeEvent event) {	}	@Override	public void onActiveDataSourceChange(Map<String, DataSourceConfig> configs) {		this.init(configs);	}}