package com.dianping.zebra.group.router;import java.sql.SQLException;import java.util.ArrayList;import java.util.List;import java.util.Map;import java.util.Set;import com.dianping.zebra.group.config.datasource.entity.DataSourceConfig;import com.dianping.zebra.group.config1.ActiveDataSourceChangeEvent;import com.dianping.zebra.group.config1.BaseGroupConfigChangeEvent;import com.dianping.zebra.group.config1.GroupConfigChangeListener;import com.dianping.zebra.group.util.SqlUtils;/** * 读写分离的DataSource选择器 */public class GroupReadWriteDataSourceRouter implements GroupDataSourceRouter, GroupConfigChangeListener {	private GroupWeightDataSourceRouter readrouter;	private GroupWeightDataSourceRouter writerouter;	public GroupReadWriteDataSourceRouter(Map<String, DataSourceConfig> DataSourceConfigs) {		this.init(DataSourceConfigs);	}	public void init(Map<String, DataSourceConfig> DataSourceConfigs) {		List<DataSourceConfig> readDataSourceConfigs = new ArrayList<DataSourceConfig>();		List<DataSourceConfig> writeDataSourceConfigs = new ArrayList<DataSourceConfig>();		for (DataSourceConfig config : DataSourceConfigs.values()) {			boolean readonly = config.isReadonly();			if (readonly) {				readDataSourceConfigs.add(config);			} else {				writeDataSourceConfigs.add(config);			}		}		this.readrouter = new GroupWeightDataSourceRouter(readDataSourceConfigs, true);		this.writerouter = new GroupWeightDataSourceRouter(writeDataSourceConfigs, false);	}	@Override	public GroupDataSourceTarget select(GroupDataSourceRouterInfo routerInfo) {		return this.select(routerInfo, null);	}	@Override	public GroupDataSourceTarget select(GroupDataSourceRouterInfo routerInfo, Set<GroupDataSourceTarget> excludeTargets) {		GroupDataSourceContext dsContext = GroupDataSourceContext.get();		if (dsContext.isForceReadFromMaster() || dsContext.isForceReadFromMasterByCookie()) {			return writerouter.select(routerInfo, excludeTargets);		} else {			// 判断出sql的SqlType，算出它是read还是write			SqlType sqlType = getSqlType(routerInfo);			if (sqlType.isRead()) {				return readrouter.select(routerInfo, excludeTargets);			} else {				return writerouter.select(routerInfo, excludeTargets);			}		}	}	private SqlType getSqlType(GroupDataSourceRouterInfo routerInfo) {		String sql = routerInfo.getSql();		try {			return SqlUtils.getSqlType(sql);		} catch (SQLException e) {			throw new RuntimeException(e.getMessage(), e);		}	}	public String getName() {		return this.getName();	}	@Override	public void onChange(BaseGroupConfigChangeEvent event) {		if (event instanceof ActiveDataSourceChangeEvent) {			this.init(event.getDatasourceConfigs());		}	}	@Override	public String getRouterStrategy() {		return "roundrobin";	}}