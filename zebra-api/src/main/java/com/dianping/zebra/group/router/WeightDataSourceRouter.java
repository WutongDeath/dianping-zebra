package com.dianping.zebra.group.router;import java.util.Map;import java.util.Random;import java.util.Set;import java.util.TreeSet;import com.dianping.zebra.group.config.datasource.entity.DataSourceConfig;/** * 按权重做路由的DataSource选择器 */public class WeightDataSourceRouter implements DataSourceRouter {	private WeightRandom weightRandom;	public WeightDataSourceRouter(Map<String, DataSourceConfig> dataSourceConfigs) {		this.weightRandom = new WeightRandom(dataSourceConfigs);	}	@Override	public RounterTarget select(RouterContext routerInfo) {		return weightRandom.select(routerInfo.getExcludeTargets());	}	private static class WeightRandom {		private int groupDataSourceTargetSize = 0;		private TreeSet<RounterTarget> targets = new TreeSet<RounterTarget>();		private Random random = new Random();		public WeightRandom(Map<String, DataSourceConfig> configs) {			for (DataSourceConfig config : configs.values()) {				int weight = config.getWeight();				groupDataSourceTargetSize += weight;				RounterTarget groupDataSourceTarget = new RounterTarget(config.getId(), weight,				      groupDataSourceTargetSize - 1);				targets.add(groupDataSourceTarget);			}		}		public RounterTarget select(Set<RounterTarget> excludeTargets) {			TreeSet<RounterTarget> weights = this.targets;			int groupDataSourceTargetSize = this.groupDataSourceTargetSize;			if (excludeTargets != null && !excludeTargets.isEmpty()) {				// 需要排除某些GroupDataSourceTarget的话，就重新copy一个weights				TreeSet<RounterTarget> copyWeights = new TreeSet<RounterTarget>(weights);				for (RounterTarget target : excludeTargets) {					if (copyWeights.remove(target)) {						groupDataSourceTargetSize -= target.getWeight();					}				}				weights = copyWeights;			}			if (weights.isEmpty() || groupDataSourceTargetSize <= 0) {				return null;			}			int randomNum = random.nextInt(groupDataSourceTargetSize);			RounterTarget tempForSearch = new RounterTarget(null, -1, randomNum);			return weights.ceiling(tempForSearch);		}	}	@Override	public String getName() {		return "weight-random";	}}